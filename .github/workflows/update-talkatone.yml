name: Update Talkatone rules
on:
  schedule:
    - cron: '0 0 * * *'   # 每天 00:00 UTC 运行
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fetch source
        run: |
          SRC_URL="https://raw.githubusercontent.com/LOWERTOP/Shadowrocket-First/refs/heads/main/Talkatone.sgmodule"
          curl -fsSL "$SRC_URL" -o source.sgmodule
      - name: Convert to payload YAML (write to clash/)
        run: |
          mkdir -p clash
          cat > clash/Talkatone.payload.yml <<'YAML'
# NAME: Talkatone
# REPO: https://github.com/ioooo0o/rules
# 整理作者：https://github.com/LOWERTOP
# 仓库地址：https://github.com/LOWERTOP/Shadowrocket-First
payload:
YAML
          # 抓取以 DOMAIN- / DOMAIN-WILDCARD / IP-CIDR 开头的行，保留逗号后所有内容（例如保留 no-resolve）
          grep -E '^(DOMAIN-|DOMAIN-WILDCARD|IP-CIDR)' source.sgmodule | sed -E 's/^[[:space:]]*//' | while IFS= read -r line; do
            key="${line%%,*}"
            rest="${line#*,}"
            echo "  - ${key},${rest}" >> clash/Talkatone.payload.yml
          done
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add clash/Talkatone.payload.yml
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "chore: update clash/Talkatone.payload.yml from upstream"
          git push
